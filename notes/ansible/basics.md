# Ansible
- Configuration as Code
- Idempotency is important in ansible. Idempotency means that result matters the most.
The task is idempotent if it's output remains same regardless.
e.g. If user is already present then task to add user shouldn't fail.

## inventory
- Assets to be managed.
- Default inventory is in `/etc/ansible/hosts`.
- Can be defined per project in file format and using **`-i <filename>`** flag.

## ad-hoc commands
- `ansible` command can be used to run ad-hoc commands
- ex. `ansible <host_name> -m <module_name> -a <args>`
- `ansible-doc` for checking documentation from cli. e.g. `ansible-doc -t module <module_name>`

## common modules
- `ansible.builtin.command`<sup>*</sup> - Useful to run commands on hosts without shell and piping outputs
    doesn't work.- `ansible.builtin.shell` - Useful to run command using shell, piping works.
- `ansible.builtin.raw`<sup>*</sup> - Useful to run commands without python installed. All modules use python so if python
is not installed then use this to run command.
- `ansible.builtin.package`<sup>*</sup> - Useful to install packages on all distros. But it's always better to use specific module than generic.
<br>
**\*** - Always prefer specific module over this to do something.

## Playbooks
- Use `ansible-playbook` command
- Each playbook can have multiple plays.
- Each play has at least following properties: name, hosts, tasks.
- template of playbook:
```yaml
- name: play-name
  hosts: host1
  tasks:
    - name: task1
      <module_name>:
        key: value

- name: play-name2
  hosts: host2
  tasks:
    - name: task1
      <module_name>:
        key: value
```
### Best Practices
- Use variables to separate site-specific playbooks.
- Make your playbook such that it will be mostly common for all the sites.
- But for specific sites it should be dynamic using variables.
- Use facts for site-specific work if needed.
- Decouple site-specific and generic tasks.
### Variables
- Variables can be user-defined or ansible gathered facts.
- They are declared using `vars` key in the play.
The variables that are defined in one play using `vars` can't be used in another.
```yaml
- name: play-name
  hosts: host1
  vars:
    name: value
  tasks:
    - name: task1
      <module_name>:
        key: value
```
- If we use `ansible-playbook -e <name>=<value>` flag the value will be overridden.
- We can define variables in files and include `var_files:`.
- We can also prompt for value using `vars_prompt:`.
- Variables can also be defined dynamically for task using `set_fact` module. Which sets variable only for **specific** host.
- We can create a `group_vars` directory, in which we can define vars for group of hosts defined in inventory.
The name of the files of vars should be same as group name.
- Use `{{ var_name }}` to access variables. If value starts with variables use `"{{ myvar }} is set"`.
- In `when` `{{ }}` are not required.
- Value with variables should be in `""`
- It is not good practise to define variables in playbook as it makes harder to decouple site-specific information.
### Ansible facts.
- Facts are variables generated by ansible in fact gathering stage that contain information about site(device).
- They contain information about host. And they are stored in `ansible_facts` variable which is dictionary.
- For version older than 2.5 they generally start with `ansible_`.
- They can be accessed as `ansible_facts['default_ipv4']['address']` which is preferred way.
- Otherwise as `ansible_facts.default_ipv4.address` not preferred.
- Or in older versions as ansible_default_ipv4.address
- Gathering facts takes time and if you do not need to use facts then for a play it can be disabled in play header using `gather_facts: no`.
- `setup` module gives you all the facts if you want to see them before hand.
