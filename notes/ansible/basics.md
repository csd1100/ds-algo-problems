# Ansible
- Configuration as Code
- Idempotency is important in ansible. Idempotency means that result matters the most.
The task is idempotent if it's output remains same regardless.
e.g. If user is already present then task to add user shouldn't fail.

## Inventory
- Assets to be managed.
- Default inventory is in `/etc/ansible/hosts`.
- Can be defined per project in file format and using **`-i <filename>`** flag.

## Ad-hoc commands
- `ansible` command can be used to run ad-hoc commands
- ex. `ansible <host_name> -m <module_name> -a <args>`
- `ansible-doc` for checking documentation from cli. e.g. `ansible-doc -t module <module_name>`

## Common modules
- `ansible.builtin.command`<sup>*</sup> - Useful to run commands on hosts without shell and piping outputs
    doesn't work.- `ansible.builtin.shell` - Useful to run command using shell, piping works.
- `ansible.builtin.raw`<sup>*</sup> - Useful to run commands without python installed. All modules use python so if python
is not installed then use this to run command.
- `ansible.builtin.package`<sup>*</sup> - Useful to install packages on all distros. But it's always better to use specific module than generic.
<br>
**\*** - Always prefer specific module over this to do something.

## Playbooks
- Use `ansible-playbook` command
- Each playbook can have multiple plays.
- Each play has at least following properties: name, hosts, tasks.
- template of playbook:
```yaml
- name: play-name
  hosts: host1
  tasks:
    - name: task1
      <module_name>:
        key: value

- name: play-name2
  hosts: host2
  tasks:
    - name: task1
      <module_name>:
        key: value
```
### Best Practices
- Use variables to separate site-specific playbooks.
- Make your playbook such that it will be mostly common for all the sites.
- But for specific sites it should be dynamic using variables.
- Use facts for site-specific work if needed.
- Decouple site-specific and generic tasks.
### Variables
- Variables can be user-defined or ansible gathered facts.
- They are declared using `vars` key in the play.
The variables that are defined in one play using `vars` can't be used in another.
```yaml
- name: play-name
  hosts: host1
  vars:
    name: value
  tasks:
    - name: task1
      <module_name>:
        key: value
```
- If we use `ansible-playbook -e <name>=<value>` flag the value will be overridden.
- We can define variables in files and include `var_files:`.
- We can also prompt for value using `vars_prompt:`.
- Variables can also be defined dynamically for task using `set_fact` module. Which sets variable only for **specific** host.
- We can create a `group_vars` directory, in which we can define vars for group of hosts defined in inventory.
The name of the files of vars should be same as group name.
- Use `{{ var_name }}` to access variables. If value starts with variables use `"{{ myvar }} is set"`.
- In `when` `{{ }}` are not required.
- Value with variables should be in `""`
- It is not good practise to define variables in playbook as it makes harder to decouple site-specific information.
### Ansible facts.
- Facts are variables generated by ansible in fact gathering stage that contain information about site(device).
- They contain information about host. And they are stored in `ansible_facts` variable which is dictionary.
- For version older than 2.5 they generally start with `ansible_`.
- They can be accessed as `ansible_facts['default_ipv4']['address']` which is preferred way.
- Otherwise as `ansible_facts.default_ipv4.address` not preferred.
- Or in older versions as ansible_default_ipv4.address
- Gathering facts takes time and if you do not need to use facts then for a play it can be disabled in play header using `gather_facts: no`.
- `setup` module gives you all the facts if you want to see them before hand.
- If facts gathering is slow setup host name resolution i.e. specify entries in `/etc/hosts` for faster resolution.
### Magic variables
- Magic variables are variables that reserved ansible variables and cannot be used.
- they are
    - hostvars
    - groups
    - group_names
    - inventory_hostname
    - inventory_hostname_short

### Registers
- They are variables to store command result
- We can use `register: <var_name>` to store result of command.
- e.g.
```yaml
- name: Registers
  hosts: localhost
  tasks:
    - name: ls
      shell: ls
      register: ls_out
    - debug:
        var: ls_out
    - debug:
        msg: status code of ls {{ ls_out['rc'] }}
```

### Conditionals
#### Handlers
- A handler is task is only executed when task it is triggered by has changed something.
- They are executed after tasks in playbooks.
- If any task fails after task that triggers handler then handler is not executed but `force_handlers` a boolean value can be used in play definition to run handler forcefully.
- Handlers are defined using `handlers:` in play.
- `notify:` is used in tasks to trigger handlers.
e.g.
```yaml
- name: handlers play
  hosts: localhost
  tasks:
    - name: write hello_world
      shell: echo hello_world > /tmp/tmp
      notify:
        - copy_hello_world
  handlers:
    - name: copy_hello_world
      shell: cp /tmp/tmp /tmp/hello_world

```
#### When
- Tasks are run only when a condition is true.
- Using `when:` in task definition.
- We can use `when: myvar is defined` to check if variable is present.
- We can use `when: myvar in vars` to check if value of `myvar` is present in `vars` variable.
- We can also use python functions in when like `find()`
## Ansible vault
- Store secure data using encryption.
- Can be used using `ansible-vault` command
